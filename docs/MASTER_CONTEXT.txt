# DPR AUTOMATION PLATFORM - MASTER CONTEXT DOCUMENT
# Use this to restore full context in a new chat window

================================================================================
## SECTION 1: PROJECT OVERVIEW
================================================================================

**Project Name:** AI-Powered DPR Automation Platform for MSMEs

**Goal:** Build a LangGraph-based multi-agent system to automate generation of 
MSE-CDP compliant Detailed Project Reports (DPRs) for MSME clusters in India.

**Problem Statement:**
- India's 6.3 crore MSMEs face 86% credit exclusion
- DPR preparation takes 6-9 months and costs â‚¹1-6 lakhs
- 60-70% rejection rate due to incomplete/non-compliant documentation
- Requires 21 mandatory sections covering legal, technical, financial, market, compliance

**Solution:**
Multi-agent AI system that:
- Reduces DPR time from 6 months to 2-3 days (90% reduction)
- Reduces cost from â‚¹2 lakhs to â‚¹10,000 (95% reduction)
- Increases approval rate from 30% to 75%+
- Uses LangGraph + Google Gemini AI + domain knowledge

**Technology Stack:**
- LangGraph (multi-agent orchestration)
- Google Gemini (ChatVertexAI - gemini-2.0-flash-exp)
- Python 3.x
- langchain-core, langchain-google-vertexai, termcolor

================================================================================
## SECTION 2: ARCHITECTURE DECISIONS
================================================================================

### Core Principles:
1. âœ… **Incremental Development** - Build stage by stage, test each stage
2. âœ… **Modular Design** - Each agent in separate file
3. âœ… **Get Permission** - Always ask before generating code
4. âœ… **Testable** - Each stage must be independently testable
5. âœ… **Git Branching** - Each stage in separate branch, merge to master

### File Structure:
```
/home/bhagavan/aura/dprai/src/
â”œâ”€â”€ config.py                    # LLM config & settings
â”œâ”€â”€ lg_utility.py                # Helper functions (graph viz, state dump)
â”œâ”€â”€ dpr_orchestrator.py          # Main orchestrator (imports all agents)
â”œâ”€â”€ data_collection_agent.py     # Stage 2 agent
â”œâ”€â”€ financial_agent.py           # Stage 3 agent
â”œâ”€â”€ document_generator.py        # Stage 4 agent (planned)
â””â”€â”€ dpr_main.py                  # Entry point for testing
```

### State Structure:
```python
class DPRState(TypedDict):
    messages: Annotated[list[BaseMessage], add_messages]
    project_data: dict          # Collected from user
    validation: dict            # Validation results
    dpr_sections: dict          # Generated DPR sections
    current_stage: str          # Current processing stage
```

### Agent Pattern (from reference code):
- Each agent has init function
- Agent function (main logic)
- Uses LLM with tools when needed
- Updates state
- Returns modified state

### Orchestrator Pattern:
- Imports all agents
- Builds StateGraph
- Adds nodes (one per agent/function)
- Adds edges (defines flow)
- Compiles graph
- Saves PNG visualization

### Naming Conventions:
- Files: `{agent_name}_agent.py`
- Functions: `{agent_name}_agent(state)` or `{function_name}(state)`
- Git branches: `feature/stage-{N}-{description}`

================================================================================
## SECTION 3: STAGE-BY-STAGE PLAN
================================================================================

### COMPLETED STAGES:

**Stage 1: Foundation & Basic Orchestrator** âœ…
- Branch: `feature/stage-1-orchestrator-foundation`
- Files created:
  * config.py
  * lg_utility.py
  * dpr_orchestrator.py (4 dummy nodes)
  * dpr_main.py
- Graph: START â†’ INIT â†’ COORDINATOR â†’ PLANNER â†’ FORMATTER â†’ END
- Status: âœ… Tested and working

**Stage 2: Data Collection Agent** âœ…
- Branch: `feature/stage-2-data-collection-agent`
- Files added/modified:
  * data_collection_agent.py (NEW)
  * dpr_orchestrator.py (UPDATED - integrated data agent)
- Features:
  * LLM-powered data extraction
  * Validates 7 required fields: cluster_type, location, members, project_cost, 
    facility_type, grant_scheme, subsidy_range
  * Type validation (integers, numbers)
  * Range validation (members > 0, cost > 0)
  * Stores in state["project_data"]
- Graph: START â†’ INIT â†’ DATA_COLLECTION â†’ COORDINATOR â†’ PLANNER â†’ FORMATTER â†’ END
- Status: âœ… Tested and working

**Stage 3: Financial Modeling Agent** âœ…
- Branch: `feature/stage-3-financial-agent`
- Files added/modified:
  * financial_agent.py (NEW)
  * dpr_orchestrator.py (UPDATED - integrated financial agent)
- Features:
  * Calculates NPV, IRR, DSCR, break-even, payback period
  * MSE-CDP compliance validation
  * 10-year simplified projections
  * DUMMY calculations for NPV/IRR (clearly marked with debug prints)
  * PYTHON formulas for DSCR, break-even, payback (with simulated inputs)
  * Stores in state["dpr_sections"]["financial"]
- Graph: START â†’ INIT â†’ DATA_COLLECTION â†’ FINANCIAL_MODELING â†’ COORDINATOR â†’ PLANNER â†’ FORMATTER â†’ END
- Status: âœ… Tested and working

### PLANNED STAGES:

**Stage 4: Document Generation Agent** (NEXT)
- Branch: `feature/stage-4-document-generator`
- File: `document_generator.py`
- Will generate:
  * Actual DPR sections using collected data
  * Executive Summary
  * Financial sections using calculated metrics
  * Technical feasibility content
  * Formatted professional document
  * Downloadable output

**Stage 5+: Additional Agents**
- Technical Feasibility Agent
- Compliance Validation Agent
- Market Analysis Agent
- Risk Analysis Agent
- etc.

================================================================================
## SECTION 4: REFERENCE CODE PATTERNS
================================================================================

### Reference Architecture (from uploaded examples):
The user provided working examples of a multi-agent orchestrator that:
- Coordinates between 3 vendor agents (Flipkart, Amazon, Sapna)
- Each agent has quotation and order placement modes
- Uses tools (item lookup, pricing, delivery, order placement)
- Orchestrator compares quotes and splits orders across vendors

Key patterns observed:
1. Each agent in separate file
2. Agent has multiple tools bound to LLM
3. Two modes: QUOTATION_MODE and ORDER_MODE (different tool sets)
4. Router function for conditional edges
5. Summarize node at the end
6. Tools are Python functions with @tool decorator

### Sample Agent Structure:
```python
# {vendor}_order_agent.py

def {vendor}_agent_init(state):
    # Display input
    return state

def {vendor}_agent(state, llm_quotation, llm_order):
    # Main agent logic
    # Uses different LLM bindings based on mode
    return state

def {vendor}_order_summarize(state, llm):
    # Summarize results
    return state

def router(state):
    # Route to tools or summarize
    return "tools" or "SUMMARIZE"

def {vendor}_build_order_agent():
    # Build graph
    builder = StateGraph(MessagesState)
    builder.add_node("INIT", init_func)
    builder.add_node("AGENT", agent_func)
    builder.add_node("tools", ToolNode(tools))
    builder.add_node("SUMMARIZE", summarize_func)
    # Add edges
    # Compile
    return graph

# Export graph
{vendor}_graph = {vendor}_build_order_agent()
```

================================================================================
## SECTION 5: USER REQUIREMENTS & CONSTRAINTS
================================================================================

### Must-Have Features:
1. âœ… Incremental testing at each stage
2. âœ… Each agent in separate file (modular)
3. âœ… Validate data at each step
4. âœ… Use Google Gemini (ChatVertexAI)
5. âœ… Generate 21 sections of MSE-CDP compliant DPR
6. âœ… Real-time validation of financial viability
7. âœ… Sector-specific content generation
8. âœ… User guidance through data collection

### User Workflow Preferences:
1. **Always ask permission before generating code**
2. **Test each stage before moving to next**
3. **Use Git branching for each stage**
4. **Keep dpr_main.py simple and unchanged when possible**
5. **Show colored console output for tracking**
6. **Generate graph PNG visualization**

### DPR Requirements:
- 21 mandatory sections (MSE-CDP compliant)
- Financial viability checks:
  * NPV > 0
  * IRR > 10%
  * DSCR > 3:1
  * Break-even < 60%
  * 60% capacity utilization proof
- Include: SPV structure, shareholding, governance
- Include: 10-year projections
- Include: compliance documents checklist

================================================================================
## SECTION 6: CURRENT STATE (END OF STAGE 3)
================================================================================

### Working Files:
1. config.py - Configuration (LLM model, DPR sections list, timeouts)
2. lg_utility.py - Utilities (save_graph_as_png, dump_state, format_output)
3. dpr_orchestrator.py - Main orchestrator with 6 nodes
4. data_collection_agent.py - Data extraction and validation
5. financial_agent.py - Financial modeling and calculations
6. dpr_main.py - Test entry point

### Current Graph Flow:
```
START 
  â†“
ORCHESTRATOR_INIT (initialize state)
  â†“
DATA_COLLECTION_AGENT (extract & validate project data)
  â†“
FINANCIAL_MODELING_AGENT (calculate financial metrics & projections)
  â†“
COORDINATOR_AGENT (use collected data + financial status)
  â†“
WORKFLOW_PLANNER (plan next steps - dummy)
  â†“
OUTPUT_FORMATTER (format final output with project + financial summary)
  â†“
END
```

### Test Results (Stage 3):
âœ… All nodes execute successfully
âœ… Data extracted: cluster_type, location, members, project_cost, facility_type, 
   grant_scheme, subsidy_range
âœ… Validation: All required fields present
âœ… Financial metrics calculated:
   - NPV: â‚¹28,700,000 âœ… PASS (DUMMY calculation)
   - IRR: 15.5% âœ… PASS (DUMMY calculation)
   - DSCR: 2.67 âŒ FAIL (PYTHON formula with simulated inputs)
   - Break-even: 80.0% âŒ FAIL (PYTHON formula with simulated inputs)
   - Payback: 8.3 years (PYTHON formula with simulated inputs)
âœ… MSE-CDP Compliance: NON_COMPLIANT (example shown)
âœ… 10-year projections: SIMPLIFIED (to be enhanced)
âœ… Clear DEBUG markers: All dummy sections marked with debug prints
âœ… Financial summary displayed in output
âœ… Ready for Stage 4

### Sample Test Input:
```python
prompt = """
I need to create a DPR for my MSME cluster project with the following details:
- Cluster Type: Printing Industry
- Location: Tirupati, Andhra Pradesh
- Number of Members: 50 units
- Project Cost: â‚¹8.2 crore
- Common Facility Centre: Digital Printing Equipment
- Seeking: MSE-CDP Grant (60-80% subsidy)
Please help me generate a complete DPR with all 21 sections.
"""
```

### Sample Output (Stage 3):
```json
{
  "status": "Stage 3 Complete",
  "orchestrator": "âœ… Functional",
  "data_collection": "âœ… Integrated",
  "financial_modeling": "âœ… Integrated",
  "project_data_collected": 8,
  "validation": "âœ… Passed",
  "project_summary": {
    "cluster": "Printing Industry",
    "location": "Tirupati, Andhra Pradesh",
    "members": 50,
    "cost": 82000000
  },
  "financial_summary": {
    "npv": 28700000.0,
    "irr": 15.5,
    "dscr": 2.67,
    "breakeven": 80.0,
    "compliance": "NON_COMPLIANT",
    "note": "âš ï¸ Using simulated calculations"
  },
  "next_step": "Stage 4 - Add Document Generation Agent"
}
```

================================================================================
## SECTION 7: NEXT STEPS (STAGE 4)
================================================================================

### Stage 4 Plan: Document Generation Agent

**What to build:**
- File: `document_generator.py`
- Generate actual DPR sections using collected data and financial metrics
- Format professional document content
- Create downloadable output

**Integration:**
- Import into dpr_orchestrator.py
- Add node: DOCUMENT_GENERATOR_AGENT
- Insert after FINANCIAL_MODELING_AGENT, before COORDINATOR_AGENT
- Generate sections based on template and collected data
- Store results in state["dpr_sections"]

**Awaiting user permission to proceed with Stage 4.**

================================================================================
## SECTION 8: HOW TO USE THIS CONTEXT DOCUMENT
================================================================================

### To Restore Context in New Chat:

1. **Start new chat with Claude**

2. **Share this entire document** with message:
   ```
   I'm continuing work on the DPR Automation Platform project.
   Here is the complete context from our previous conversation.
   Please read this and confirm you understand where we are.
   
   [PASTE ENTIRE CONTEXT DOCUMENT]
   
   Current Status: Completed Stage 2, ready for Stage 3
   Question: [Your question or "Ready to proceed with Stage 3"]
   ```

3. **Claude will:**
   - Understand full project context
   - Know all decisions made
   - Remember architecture patterns
   - Continue from current stage
   - Maintain same working style (ask permission, incremental, etc.)

### Quick Reference Commands:

**To test current stage:**
```bash
cd /home/bhagavan/aura/dprai/src/
python dpr_main.py
```

**To create new stage branch:**
```bash
git checkout -b feature/stage-{N}-{description}
```

**To see graph structure:**
```bash
# PNG file generated automatically
# Location: dpr_orchestrator_graph.png
```

================================================================================
## SECTION 9: IMPORTANT NOTES
================================================================================

### Working Environment:
- User's system: Ubuntu 22.04
- Python environment: (dpr) virtual environment
- Working directory: /home/bhagavan/aura/dprai/src/

### User Preferences:
- Uses "dpr_main.py" (not main.py)
- Wants modular design (agent per file)
- Wants to test each stage before proceeding
- Uses Git for version control
- Values clear communication and asking permission

### Communication Style:
- Always ask before generating code
- Explain what will be done before doing it
- Show file structure clearly
- Provide download links for all files
- Give clear "Ready to proceed?" confirmations
- Use emojis for visual clarity (âœ… âŒ ğŸ¯ etc.)

### Technical Details:
- LLM Model: "gemini-2.0-flash-exp"
- Uses ChatVertexAI from langchain-google-vertexai
- Colored output with termcolor
- Graph visualization with save_graph_as_png
- State uses TypedDict with Annotated messages

================================================================================
## SECTION 10: CONTACT & SESSION INFO
================================================================================

**Original Session Date:** October 27, 2025
**User:** bhagavan@auranet (Bengaluru, Karnataka, IN)
**Project Path:** /home/bhagavan/aura/dprai/src/

**Stages Completed:**
- âœ… Stage 1: Foundation & Basic Orchestrator
- âœ… Stage 2: Data Collection Agent
- âœ… Stage 3: Financial Modeling Agent

**Current Stage:** Ready for Stage 4: Document Generation Agent

**Git Branches:**
- feature/stage-1-orchestrator-foundation (merged)
- feature/stage-2-data-collection-agent (merged)
- feature/stage-3-financial-agent (ready to merge)
- feature/stage-4-document-generator (to be created)

================================================================================
END OF CONTEXT DOCUMENT
================================================================================

This document contains ALL instructions, decisions, code patterns, and context
needed to continue the DPR Automation Platform project in a new chat session.

Last updated: After successful Stage 3 testing
Version: 1.3